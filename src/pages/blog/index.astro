---
import ArrowCard from "@components/ArrowCard.astro";
import Container from "@components/Container.astro";
import { BLOG } from "@consts";
import Layout from "@layouts/Layout.astro";
import { type CollectionEntry, getCollection } from "astro:content";
import { getTopicDefinitions } from "@lib/topics";

const data = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

type Acc = {
  [year: string]: CollectionEntry<"blog">[];
};

const posts = data.reduce((acc: Acc, post) => {
  const year = post.data.date.getFullYear().toString();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {});

const years = Object.keys(posts).sort((a, b) => parseInt(b) - parseInt(a));
const topics = getTopicDefinitions();
---

<Layout title={BLOG.TITLE} description={BLOG.DESCRIPTION}>
  <!-- Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      name: "Backend Engineering Blog",
      description:
        "In-depth technical articles on backend development, DevOps, PostgreSQL, Kubernetes, and system architecture",
      url: "https://www.saybackend.com/blog/",
      isPartOf: {
        "@type": "WebSite",
        "@id": "https://www.saybackend.com/#website",
      },
      breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: "https://www.saybackend.com/",
          },
          {
            "@type": "ListItem",
            position: 2,
            name: "Blog",
            item: "https://www.saybackend.com/blog/",
          },
        ],
      },
    })}
  />
  <div class="pt-20 pb-20 md:pt-24 md:pb-24">
    <Container>
      <aside data-pagefind-ignore>
        <div class="space-y-10">
          <section class="animate space-y-4">
            <div class="text-foreground font-semibold">Topics</div>
            <div class="grid gap-4 md:grid-cols-3">
              {
                topics.map((topic) => (
                  <a
                    href={`/topics/${topic.slug}`}
                    class="border-structural hover:bg-foreground hover:text-background group border p-4 transition-all duration-200"
                  >
                    <div class="text-muted-foreground mb-2 font-mono text-[10px] tracking-wider uppercase">
                      Hub page
                    </div>
                    <div class="text-sm font-bold uppercase">{topic.name}</div>
                    <div class="text-muted-foreground group-hover:text-background/80 mt-2 line-clamp-2 font-mono text-xs">
                      {topic.description}
                    </div>
                  </a>
                ))
              }
            </div>
          </section>
          <div class="space-y-4">
            {
              years.map((year) => (
                <section class="animate space-y-4">
                  <div class="text-foreground font-semibold">{year}</div>
                  <div>
                    <ul class="flex flex-col gap-4">
                      {posts[year].map((post) => (
                        <li>
                          <ArrowCard entry={post} />
                        </li>
                      ))}
                    </ul>
                  </div>
                </section>
              ))
            }
          </div>
        </div>
      </aside>
    </Container>
  </div>
</Layout>
